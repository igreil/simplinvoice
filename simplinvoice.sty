% This is file simplinvoice.sty (A fork of rechnung.sty)
% Based on code by M.G. Berberich and U. Sibiller
% See https://www.forwiss.uni-passau.de/~berberic/TeX/Rechnung/index.html
%
% This work may be distributed and/or modified under the conditions of the 
% LaTeX Project Public License, either version 1.3 of this license or 
% (at your option) any later version.
%
% Inspired by https://tex.stackexchange.com/questions/654045/
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{simplinvoice}
	[2022/08/15 v0.1 Simplinvoice by Ingmar Greil]
%
\RequirePackage{tabto}			% We could probably do without …
	\TabPositions{.75\linewidth}	% Sets a tabstop at ¾, accessible via \tab
%
%=============================================================================
%				This is simplinvoice 0.1 (2022-08-16)
% 				© Ingmar Greil, 2022
%=============================================================================
%
% Known issues / wanted features / todo: 
%
% • Remove last traces of German functions, variable names, comments etc.
%
% •	Only natural numbers are  accepted as tax rates for now 
% 	(i.e., 10, 16, 21 etc. percent – France for one uses reduced rates 
% 	of 5.5 and 2.1 percent for some goods or services. Switzerland, too.
%
% •	Even though both commas and periods are accepted for price input, all
% 	calculations will output comma separated values only – for now.
%
% •	We also need a configurable thousand separator, as in 100.000 vs. 100 000
%
% • Use \InvoiceLine* instead of \InvoiceLine[e]. Check starred commands.
%
% •	An interface with babel, to choose language and/or currency automatically
%=============================================================================
% Change as needed:
%=============================================================================
% Eventually babel is expected to carry a lot of this load
\newcommand*\@SINVstsi		{19}		% default tax rate
\newcommand*\@SINVstsii		{7}			% default tax rate, reduced
\newcommand*\@currency		{\texteuro}	% default currency
%-----------------------------------------------------------------------------
\newcommand*\@taxname		{Umsatzsteuer}				% VAT name
\newcommand*\@taxabrv		{USt.}						% VAT abbreviation
\newcommand*\@taxred		{~(erm\"a{\ss}igter Satz)}	% "recuced rate"
% FIXME						Full Unicode support needed
%-----------------------------------------------------------------------------
\newcommand*\@sumnet		{Zwischensumme}			% Net Total, before taxes
\newcommand*\@sumtot		{Gesamtsumme}			% Gross Total, with taxes
\newcommand*\@excl			{\quad zzgl.~}			% excl.
%-----------------------------------------------------------------------------
\newcommand*\@running		{Nr.}			% Number
\newcommand*\@amount		{Anzahl}		% Item amount
\newcommand*\@itemnr		{Art.-Nr.}		% Item number
\newcommand*\@description	{Beschreibung}	% Item description
\newcommand*\@unitprice		{Einzelpreis}	% Item price
\newcommand*\@totalprice	{Gesamtpreis}	% Item price × amount
%=============================================================================
\newcount\@SINVmwst			\newcount\@SINVmwsti	\newcount\@SINVmwstii
\newcount\@SINVcnt			\newcount\@SINVtmp
\newcount\@SINVsum			\newcount\@SINVtmptmp		% Just some counters
%-----------------------------------------------------------------------------
\newdimen\@SINVPosWidth		\newdimen\@SINVAmtWidth	\newdimen\@SINVwdt
\newdimen\@SINVArtNumWidth	\newdimen\@SINVArtWidth
\newdimen\@SINVSingleWidth	\newdimen\@SINVTotalWidth	% New dimensions …
%-----------------------------------------------------------------------------
\newif\if@SINVerm			\newif\if@SINVpos		\newif\if@SINVartnum
\newif\if@SINVfirst			\newif\if@SINVhor		\newif\if@SINVinit
%-----------------------------------------------------------------------------
\@SINVPosWidth		=		1em%				Nr.
\@SINVAmtWidth		=		2em%				Amount
\@SINVArtNumWidth	=		2.25em%				Article Number
\@SINVSingleWidth	=		3.25em%				Price Per Unit
\@SINVTotalWidth	=		4.25em%				Total Price
%-----------------------------------------------------------------------------
\newcommand*\postnet		{\vskip .5ex}%		Formatting After Net Total
\newcommand*\pregross		{\vskip .5ex}%		Formatting Before Gross Total
\newcommand*\headerformat	{\footnotesize}
%=============================================================================
\newcommand*\TaxRate[2]{%					Use like this in your document:
	\def\@SINVstsi{#1}\def\@SINVstsii{#2}%	\TaxRate{20}{10}
}
%-----------------------------------------------------------------------------
\newcommand*\SetCurrency[1]{%				Use like this in your document:
	\def\@currency{#1}%						\SetCurrency{CHF}
}
\newcommand*\UseEuro	{\def\@currency{\texteuro}}%	Shortcuts for EUR 
\newcommand*\UseDollar	{\def\@currency{\$}}% 			and USD symbols
%-----------------------------------------------------------------------------
\newcommand*\NumbersOn[0]	{\if@SINVinit\else\global\@SINVpostrue\fi}
\newcommand*\NumbersOff[0]	{\if@SINVinit\else\global\@SINVposfalse\fi}
\newcommand*\SeparatorOn[0]	{\if@SINVinit\else\global\@SINVhortrue\fi}
\newcommand*\SeparatorOff[0]{\if@SINVinit\else\global\@SINVhorfalse\fi}
%-----------------------------------------------------------------------------
\newcommand*\Total		{\writeCurrency\@SINVsum}
\newcommand*\TaxAmnt	{\writeCurrency\@SINVmwst}
\newcommand*\TaxName	{\@taxname}
\newcommand*\TaxAbrv	{\@taxabrv}
%-----------------------------------------------------------------------------
\newcommand*\@SINVwrite[1]{%
	\@tempcnta\the#1
	\@tempcntb\@tempcnta
	\divide\@tempcnta100 \the\@tempcnta,%
	\multiply\@tempcnta100\advance\@tempcntb-\@tempcnta
	\@tempcnta\@tempcntb\divide\@tempcnta10 \the\@tempcnta
	\multiply\@tempcnta10\advance\@tempcntb-\@tempcnta
	\the\@tempcntb
}%----------------------------------------------------------------------------
\newcommand*\writeCurrency[1]{%
	\@SINVwrite{#1}\,\@currency
}%----------------------------------------------------------------------------
\newcommand*\writebfCurrency[1]{%		Write bolded currency,
	{\bfseries\writeCurrency{#1}}%		only used once, for the total
}%----------------------------------------------------------------------------
\newcommand*\@readNum[1]{%
	\@SINVtmp=0
	\@readA#1
	\relax
}%----------------------------------------------------------------------------
\newcommand*\@readA[1]{%
	\expandafter\if#1\relax\@tempcnta0\@readC\relax
	\else\expandafter\if#1.\@tempcnta0
	\expandafter\expandafter\expandafter\expandafter
	\expandafter\expandafter\expandafter\@readB
	\else\expandafter\if#1,\@tempcnta0
	\expandafter\expandafter\expandafter\expandafter
	\expandafter\expandafter\expandafter\@readB
	\else\multiply\@SINVtmp10\advance\@SINVtmp#1
	\expandafter\expandafter\expandafter\expandafter
	\expandafter\expandafter\expandafter\@readA
	\fi\fi\fi
}
%-----------------------------------------------------------------------------
\newcommand*\@readB[1]{%
  \expandafter\if#1\relax\relax
     \ifnum \@tempcnta > 2
       \@SINVtmp0\PackageError{simplinvoice}{mehr als zwei
       Nachkommastellen gefunden}
     \else
       \ifnum \@tempcnta = 2
       \else
         \ifnum \@tempcnta > 0 
   \advance\@tempcnta1
           \multiply\@SINVtmp10
   \@readB\relax
         \else					% FIXME
           \multiply\@SINVtmp100\PackageError{simplinvoice}{Keine
           Nachkommastellen gefunden}
         \fi
       \fi
    \fi
  \else
     \advance\@tempcnta1
     \multiply\@SINVtmp10
     \advance\@SINVtmp#1\expandafter\@readB
  \fi}
%-----------------------------------------------------------------------------
\newcommand*\@readC[1]{%
  \expandafter
  \if#1\relax\relax
     \ifnum \@tempcnta > 2
								% FIXME
       \@SINVtmp0\PackageError{simplinvoice}{Mehr als drei Nachkommastellen gefunden}
     \fi
     \ifnum \@tempcnta < 2
 \advance\@tempcnta1
         \multiply\@SINVtmp10
 \@readC\relax
     \fi
  \else
     \advance\@tempcnta1
     \multiply\@SINVtmp10
     \advance\@SINVtmp#1\expandafter\@readC
  \fi}
\newcommand*{\writefoot}[0]{
  \if@SINVerm
    \nointerlineskip
    \vskip0.5ex
    \hbox to \textwidth{
      \hfill\footnotesize\strut	% FIXME There must be alternatives to Math mode
      $^*$ Artikel mit \@SINVstsii\tab \% \@taxname}%
  \fi}
%-----------------------------------------------------------------------------
\newcommand*\@SINVsline[2]{%
	\goodbreak
  \vbox{%
    \hbox to\textwidth{%
      \strut\sep #1\hfil
      \sep\sep
      \hbox to \@SINVTotalWidth{\hfil#2}%
      \sep}%
\vskip 1.4pt}}
\newcommand*\@SINVohne{
  \@SINVsline{\@sumtot}{\writebfCurrency\@SINVsum}}
%-----------------------------------------------------------------------------
\newcommand*\@SINVnetto{%
	\@SINVsline{\@sumnet}{\writeCurrency\@SINVsum}\postnet%
	\multiply\@SINVmwsti\@SINVstsi
	\advance\@SINVmwsti50\divide\@SINVmwsti100
	\multiply\@SINVmwstii\@SINVstsii
	\advance\@SINVmwstii50\divide\@SINVmwstii100
	\@SINVmwst\@SINVmwsti\advance\@SINVmwst\@SINVmwstii
	\if@SINVerm
	\@SINVsline{\@excl\@SINVstsii\,\%~\@taxabrv \@taxred}{\writeCurrency\@SINVmwstii}
	\fi
	\@SINVsline{\@excl\@SINVstsi\,\%~\@taxabrv}{\writeCurrency\@SINVmwsti}
	\advance\@SINVsum\@SINVmwst
	\pregross
	\@SINVsline{\@sumtot}{\writebfCurrency\@SINVsum}%
	\writefoot
}
%-----------------------------------------------------------------------------
\newcommand*\@SINVbrutto{
  \@SINVsline{\@sumtot}{\writebfCurrency\@SINVsum}
  \multiply\@SINVmwsti\@SINVstsi\multiply\@SINVmwsti2%
  \@tempcnta100\advance\@tempcnta\@SINVstsi
  \advance\@SINVmwsti\@tempcnta
  \multiply\@tempcnta2%
  \divide\@SINVmwsti\@tempcnta

  \multiply\@SINVmwstii\@SINVstsii\multiply\@SINVmwstii2%
  \@tempcnta100\advance\@tempcnta\@SINVstsii
  \advance\@SINVmwstii\@tempcnta
  \multiply\@tempcnta2%
  \divide\@SINVmwstii\@tempcnta

  \@SINVmwst\@SINVmwsti\advance\@SINVmwst\@SINVmwstii
  \if@SINVerm
    \@SINVsline{inkl. erm. \@taxabrv \@SINVstsii\%}
    {\writeCurrency\@SINVmwstii}%
  \fi
  \@SINVsline{inkl. \@SINVstsi\% \@taxabrv}{\writeCurrency\@SINVmwsti}%
  \writefoot
}
%-----------------------------------------------------------------------------
\newcommand*{\sep}[0]{%
\hskip\tabcolsep
}
%-----------------------------------------------------------------------------
\newcommand*\@SINVlineX[6]{{
\goodbreak\nointerlineskip
    \vbox{
      \if@SINVhor
\hrule 
      \else
        \if@SINVfirst
        \fi
      \fi
      \hbox to\textwidth{%
\sep%
        \if@SINVpos%
           \hbox to\@SINVPosWidth{\hfil #1\strut}%
           \sep\sep
        \fi% Pos-Spalte
        \hbox to\@SINVAmtWidth{\hfil #2\strut}\sep\sep% Anzahl-Spalte
        \if@SINVartnum%
          \hbox to\@SINVArtNumWidth{\hfil #3\strut}%
          \sep\sep%
        \fi% Art-Num-Spalte
        \vtop{\normalbaselines%
           \noindent\rightskip=0pt plus1cm%
           \hsize\@SINVwdt%
           \linewidth\hsize#4\null\strut\par}%
        \hfil\sep\sep%Beschreibung
        \hbox to\@SINVSingleWidth{\hfil #5\strut}\sep\sep% Einzelpreis
        \hbox to\@SINVTotalWidth{\hfil #6\strut}\sep% Gesamtpreis
      }%hbox
     }%vbox
}}

\newcommand*\@InvoiceLine[4][X]{%
\@InvoiceLineX[#1]{#2}{}{#3}{#4}
}

\newcommand*\@InvoiceLineX[5][X]{
  \initInvoice
  \advance\@SINVcnt1%
  \@readNum{#5}
  \@SINVtmptmp=\@SINVtmp%
  \@readNum{#2}\multiply\@SINVtmp\@SINVtmptmp
  \advance\@SINVtmp99\divide\@SINVtmp100%Aufrunden auf 2 Nachkommastellen.
  \@lineBaseX[#1]{\the\@SINVcnt}{#2}{#3}{#4}{#5}
}
\newcommand*\@Versandkosten[2][X]{\@VersandkostenX[#1]{#2}}
\newcommand*\@VersandkostenX[2][X]{
  \initInvoice
  \@readNum{#2}
  \@lineBaseX[#1]{\null}{1}{\null}{Versandkosten}{#2}
}
\newcommand*\@lineBaseX[6][X]{
  \global\advance\@SINVsum\@SINVtmp
  \@SINVlineX{#2}{#3}{#4}{#5}{#6\,\@currency}{\writeCurrency\@SINVtmp
    \expandafter\ifx#1X\else\rlap{$^*$}\fi}
  \expandafter
  \ifx#1X
    \advance\@SINVmwsti\@SINVtmp
  \else
    \advance\@SINVmwstii\@SINVtmp\global\@SINVermtrue
  \fi
  \global\@SINVfirstfalse  %horizontale Linien nur beim ersten Artikel
}

\newenvironment*{invoice}[1][X]{\InvoiceStart{#1}{}}{\InvoiceEnd}
\newenvironment*{invoice*}[1][X]{\InvoiceStart{#1}{X}}{\InvoiceEnd}

\newenvironment*{order}	[0]{\InvoiceStart{X}{}}	{\InvoiceEnd}
\newenvironment*{order*}[0]{\InvoiceStart{X}{X}}{\InvoiceEnd}

\newcommand*{\InvoiceStart}[2]{%
	\@SINVinitfalse		\@SINVermfalse
	\@SINVmwsti0		\@SINVmwstii0
	\def\@SINVtype{#1}%
	\global\@SINVpostrue	\global\@SINVhortrue
	\@SINVcnt0				\@SINVsum0
	\@SINVwdt\textwidth
	\global\@SINVfirsttrue
	\advance\@SINVwdt-\@SINVAmtWidth	% Breite der Spalte Anz
	\advance\@SINVwdt-\@SINVSingleWidth	% Breite der Spalte Einzelpreis
	\advance\@SINVwdt-\@SINVTotalWidth	% Breite der Spalte Gesamtpreis
	\advance\@SINVwdt-2.0pt				% Breite der Spaltentrenner
	\advance\@SINVwdt-8\tabcolsep		% Breite des Abstands zu den Spaltentrennern
	\ifx#2X
		\global\@SINVartnumtrue
		\let\InvoiceLine\@InvoiceLineX
		\let\Posten\@InvoiceLineX
		\let\Versandkosten\@VersandkostenX
	\else
		\global\@SINVartnumfalse
		\let\InvoiceLine\@InvoiceLine
		\let\Posten\@InvoiceLine
		\let\Versandkosten\@Versandkosten
	\fi
}

\newcommand*{\initInvoice}[0]
{
  \if@SINVinit
  \else
    % Breite wegen Anzeige der Positionsnummern korrigieren
    %    \begin{macrocode}
    \if@SINVpos
      \advance\@SINVwdt-\@SINVPosWidth
      \advance\@SINVwdt-0.4pt
      \advance\@SINVwdt-2\tabcolsep
    \fi
    %    \end{macrocode}
    % Breite wegen Anzeige der Artikelnummern korrigieren
    %    \begin{macrocode}
    \if@SINVartnum
      \advance\@SINVwdt-\@SINVArtNumWidth
      \advance\@SINVwdt-0.4pt
      \advance\@SINVwdt-2\tabcolsep
    \fi
    %    \end{macrocode}
    % bißchen Platz über der Rechnung
    %    \begin{macrocode}
    \vskip\abovedisplayskip
    %    \end{macrocode}

    % Titelzeile ausgeben
    \@SINVlineX{	\headerformat	\@running		\hfill}%
              {		\headerformat	\@amount		\hfill}%
              {		\headerformat	\@itemnr		\hfill}%
              {		\headerformat	\@description	\hfill}%
              {		\headerformat	\@unitprice		\hfill}%
              {		\headerformat	\@totalprice	\hfill}
\vspace{.5ex}\par\hrule\vspace{1ex}\par
\@SINVinittrue
  \fi
}

\newcommand*{\InvoiceEnd}[0]
{
\vspace{.5ex}\par  
\hrule\vspace{1ex}\par
  \vskip\doublerulesep\vskip0.4pt
       \expandafter\if\@SINVtype X \@SINVohne
  \else\expandafter\if\@SINVtype N \@SINVnetto
  \else\expandafter\if\@SINVtype B \@SINVbrutto
  \else\PackageError{simplinvoice}{Unbekannter Rechnungstyp `\@SINVtype'}%
  \fi\fi\fi
  \global\@SINVsum\@SINVsum\global\@SINVmwst\@SINVmwst
  \vskip\belowdisplayskip
}
\endinput

% End of file simplinvoice.sty